<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8" />
	<title>ì±„íŒ…ë°©</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen py-8 px-4 relative">
<!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
<a href="/view/chatListView"
	 class="absolute top-4 left-4 px-3 py-2 rounded-xl hover:bg-gray-200 transition-all flex items-center gap-2">
	<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="30" height="30">
		<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
	</svg>
</a>

<!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
<a href="/logout"
	 class="absolute top-4 right-4 px-3 py-2 rounded-xl hover:bg-red-200 transition-all flex items-center gap-2">
	<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="30" height="30">
		<path fill-rule="evenodd" d="M16.5 3.75a1.5 1.5 0 0 1 1.5 1.5v13.5a1.5 1.5 0 0 1-1.5 1.5h-6a1.5 1.5 0 0 1-1.5-1.5V15a.75.75 0 0 0-1.5 0v3.75a3 3 0 0 0 3 3h6a3 3 0 0 0 3-3V5.25a3 3 0 0 0-3-3h-6a3 3 0 0 0-3 3V9A.75.75 0 1 0 9 9V5.25a1.5 1.5 0 0 1 1.5-1.5h6ZM5.78 8.47a.75.75 0 0 0-1.06 0l-3 3a.75.75 0 0 0 0 1.06l3 3a.75.75 0 0 0 1.06-1.06l-1.72-1.72H15a.75.75 0 0 0 0-1.5H4.06l1.72-1.72a.75.75 0 0 0 0-1.06Z" clip-rule="evenodd" />
	</svg>
</a>

<div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 flex flex-col gap-4 mt-8">
	<h2 class="text-2xl font-semibold text-gray-800 text-center">ðŸ’¬ ì±„íŒ…ë°©</h2>
	
	<div id="chat-box" class="flex-1 h-96 overflow-y-auto bg-gray-50 rounded-xl p-4 border border-gray-200 space-y-2 text-sm text-gray-700" style="max-height: 70vh; overflow-y: auto;"></div>
	
	<button id="scroll-down-btn" onclick="scrollToBottom()" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-full shadow-lg opacity-80 transition-opacity duration-300 hidden z-50" style="transform: translate(-24px, -50px);">
		â¬‡
	</button>
	
	<div class="flex gap-2">
		<input id="message" type="text" class="flex-1 p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring focus:ring-blue-200" placeholder="ë©”ì‹œì§€ë¥¼ ìž…ë ¥í•˜ì„¸ìš”" onkeydown="enterKey()" />
		<button onclick="sendMessage()" class="bg-blue-500 text-white px-5 py-2 rounded-xl hover:bg-blue-600 transition-all">ì „ì†¡</button>
	</div>
</div>

<script th:inline="javascript">
	const roomId = [[${roomId}]];
	const userId = [[${userId}]];
	const inUserIds = [[${inUserIds}]];
	let chatSocket;
	let offset = 0;
	let isLoading = false;
	const chatBox = document.getElementById("chat-box");
	const scrollBtn = document.getElementById("scroll-down-btn");
	const shownMessageIds = new Set();
	const pendingReadMessages = new Set();
	
	function connectWebSocket() {
		// chatSocket
		chatSocket = new WebSocket(`ws://${location.host}/ws/chat/${roomId}`);
	
		chatSocket.onopen = () => console.log("âœ… WebSocket ì—°ê²°ë¨");
	
		chatSocket.onmessage = (event) => {
			const msg = JSON.parse(event.data);
			const msgId = `${msg.msgId}`;
			if (!shownMessageIds.has(msgId)) {
				shownMessageIds.add(msgId);
				if (msg.sender !== userId) pendingReadMessages.add(msgId);
				const timeFormat = msg.timestamp.replace("T", " ").split(".")[0].slice(0, -3);
				const readCount = msg.readCount ?? 0;
				const readIndicator = readCount > 0 ? ` ðŸ“–(${readCount})` : "";
				const content = `[${timeFormat}] ${msg.sender}: ${msg.message}${readIndicator}`;
				appendMessage(content, false);
			}
			if (shownMessageIds.size > 200) shownMessageIds.delete(shownMessageIds.values().next().value);
		};
	
		chatSocket.onclose = () => console.warn("ðŸ” WebSocket ì¢…ë£Œë¨. ìžë™ ìž¬ì—°ê²°ì€ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
		chatSocket.onerror = (err) => console.error("âŒ WebSocket ì—ëŸ¬:", err);
		
		// readSocket
		const readSocket = new WebSocket(`ws://${location.host}/ws/read/${roomId}`);
		
		// notifySocket
		const notifySocket = new WebSocket(`ws://${location.host}/ws/notify/${userId}`);
		
		// statusSocket
		const statusSocket = new WebSocket(`ws://${location.host}/ws/status/${userId}`);
	}
	
	function sendMessage() {
		const input = document.getElementById("message");
		const message = input.value.trim();
		if (!message || chatSocket.readyState !== WebSocket.OPEN) return;
		let isNewRoomCheck = shownMessageIds.size === 0 ? 'true' : 'false';
		let parsedUserIds = Array.isArray(inUserIds)
			? inUserIds
			: typeof inUserIds === 'string'
				? inUserIds.replaceAll('[', '').replaceAll(']', '').split(',').map(s => s.trim()).filter(Boolean)
				: [];
		const totalReceivers = Math.max(0, parsedUserIds.length - 1);
		const payload = {
			roomId: roomId,
			message: message,
			isNewRoomMsg: isNewRoomCheck,
			inUserIds: parsedUserIds,
			totalReceivers: totalReceivers
		};
		chatSocket.send(JSON.stringify(payload));
		input.value = "";
	}
	
	function appendMessage(msg, prepend = false) {
		const div = document.createElement("div");
		div.textContent = msg;
		if (prepend) {
			chatBox.insertBefore(div, chatBox.firstChild);
		} else {
			chatBox.appendChild(div);
			chatBox.scrollTop = chatBox.scrollHeight;
		}
	}
	
	function enterKey() {
		if (window.event.keyCode === 13) {
			const input = document.getElementById("message");
			if (input.value.trim()) sendMessage();
		}
	}
	
	chatBox.addEventListener("scroll", () => {
		if (!isLoading && chatBox.scrollTop <= chatBox.scrollHeight * 0.3) {
			isLoading = true;
			offset += 30;
			fetch(`/api/chat/history?roomId=${roomId}&offset=${offset}`)
				.then(res => res.json())
				.then(messages => {
					if (messages.length === 0) return;
					messages.forEach(msg => {
						const msgId = `${msg.sender}-${msg.timestamp}-${msg.message}`;
						if (!shownMessageIds.has(msgId)) {
							shownMessageIds.add(msgId);
							const timeFormat = msg.timestamp.replace("T", " ").split(".")[0].slice(0, -3);
							appendMessage(`[${timeFormat}] ${msg.sender}: ${msg.message}`, true);
						}
					});
					isLoading = false;
				});
		}
		scrollBtn.classList.toggle("hidden", chatBox.scrollTop + chatBox.clientHeight >= chatBox.scrollHeight - 20);
	});
	
	function scrollToBottom() {
		chatBox.scrollTop = chatBox.scrollHeight;
	}
	
	window.addEventListener("DOMContentLoaded", connectWebSocket);
	
	window.addEventListener("focus", () => {
		pendingReadMessages.forEach(msgId => sendReadReceipt(msgId));
		pendingReadMessages.clear();
	});
	
	window.addEventListener("blur", () => {
		const beaconUrl = `/api/chat/offline?roomId=${encodeURIComponent(roomId)}&userId=${encodeURIComponent(userId)}`;
		navigator.sendBeacon(beaconUrl);
	});
	
	document.addEventListener("visibilitychange", () => {
		if (document.visibilityState === "hidden") {
			const beaconUrl = `/api/chat/offline?roomId=${encodeURIComponent(roomId)}&userId=${encodeURIComponent(userId)}`;
			navigator.sendBeacon(beaconUrl);
		}
	});
	
	function sendReadReceipt(msgId) {
		if (chatSocket.readyState !== WebSocket.OPEN) return;
		const payload = {
			type: "read",
			roomId: roomId,
			msgId: msgId,
			userId: userId
		};
		chatSocket.send(JSON.stringify(payload));
	}
</script>
</body>
</html>
